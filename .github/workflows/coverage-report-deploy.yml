# .github/workflows/coverage-report-deploy.yml
name: üß™ Deploy Coverage Report to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Run tests and generate coverage report
        run: |
          mkdir -p test-reports
          # „ÉÜ„Çπ„ÉàÂÆüË°å & „Ç´„Éê„É¨„ÉÉ„Ç∏ÁîüÊàêüî•
          go test -v -coverprofile=test-reports/coverage.out ./... 2>&1 | tee test-reports/test-output.txt

          # „Ç´„Éê„É¨„ÉÉ„Ç∏„É¨„Éù„Éº„Éà(HTML)ÁîüÊàê‚ú®
          go tool cover -html=test-reports/coverage.out -o test-reports/coverage.html

          # „Ç´„Éê„É¨„ÉÉ„Ç∏„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ë®àÁÆóüìä
          COVERAGE=$(go tool cover -func=test-reports/coverage.out | grep total | awk '{print $3}')
          echo "Total Coverage: $COVERAGE"
          echo "$COVERAGE" > test-reports/coverage-percent.txt

          # „ÉÜ„Çπ„ÉàÁµêÊûú„ÅÆ„Çµ„Éû„É™„ÉºÁîüÊàêüíï
          if grep -q "FAIL" test-reports/test-output.txt; then
            echo "FAILED" > test-reports/test-status.txt
          else
            echo "PASSED" > test-reports/test-status.txt
          fi

      - name: Create index page
        run: |
          # „Ç´„Éê„É¨„ÉÉ„Ç∏„Å®„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæó‚ú®
          COVERAGE=$(cat test-reports/coverage-percent.txt)
          TEST_STATUS=$(cat test-reports/test-status.txt)

          # „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüÁµµÊñáÂ≠ó„Å®„Ç´„É©„ÉºË®≠ÂÆöüéÄ
          if [ "$TEST_STATUS" = "PASSED" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_COLOR="#48bb78"
            STATUS_TEXT="All Tests Passed"
          else
            STATUS_EMOJI="‚ùå"
            STATUS_COLOR="#f56565"
            STATUS_TEXT="Tests Failed"
          fi

          cat > test-reports/index.html << EOF
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Go CLI Sample - Test Reports</title>
              <style>
                  /* „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†ÊúÄÈ´ò„ÄúÔºÅ‚ú®üíé */
                  @keyframes gradientMove {
                      0% { background-position: 0% 50%; }
                      50% { background-position: 100% 50%; }
                      100% { background-position: 0% 50%; }
                  }

                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }

                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 40px 20px;
                      /* „ÇÅ„Å£„Å°„ÇÉ„Ç®„É¢„ÅÑ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥üåà‚ú® */
                      background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #4facfe);
                      background-size: 400% 400%;
                      animation: gradientMove 15s ease infinite;
                      min-height: 100vh;
                  }

                  .container {
                      /* „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†„Åß„Ç≠„É©„Ç≠„É©„Å´„Äúüíé */
                      background: rgba(255, 255, 255, 0.25);
                      backdrop-filter: blur(10px) saturate(180%);
                      -webkit-backdrop-filter: blur(10px) saturate(180%);
                      border-radius: 20px;
                      padding: 50px;
                      box-shadow:
                          0 8px 32px 0 rgba(31, 38, 135, 0.37),
                          inset 0 0 0 1px rgba(255, 255, 255, 0.18);
                      border: 1px solid rgba(255, 255, 255, 0.3);
                  }

                  h1 {
                      color: #ffffff;
                      margin-bottom: 10px;
                      font-size: 2.8em;
                      font-weight: 800;
                      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                  }

                  .subtitle {
                      color: rgba(255, 255, 255, 0.95);
                      margin-bottom: 40px;
                      font-size: 1.3em;
                      font-weight: 500;
                      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                  }

                  .stats {
                      display: flex;
                      gap: 20px;
                      margin: 40px 0;
                  }

                  .stat-box {
                      flex: 1;
                      /* „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†„ÅÆstat-boxüíï */
                      background: rgba(255, 255, 255, 0.2);
                      backdrop-filter: blur(10px);
                      -webkit-backdrop-filter: blur(10px);
                      color: white;
                      padding: 30px 20px;
                      border-radius: 16px;
                      text-align: center;
                      border: 1px solid rgba(255, 255, 255, 0.3);
                      box-shadow:
                          0 8px 32px 0 rgba(31, 38, 135, 0.2),
                          inset 0 0 0 1px rgba(255, 255, 255, 0.1);
                      transition: all 0.3s ease;
                  }

                  .stat-box:hover {
                      transform: translateY(-5px);
                      box-shadow:
                          0 12px 40px 0 rgba(31, 38, 135, 0.3),
                          inset 0 0 0 1px rgba(255, 255, 255, 0.2);
                  }

                  .stat-value {
                      font-size: 3em;
                      font-weight: 900;
                      margin: 15px 0;
                      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                  }

                  .stat-label {
                      font-size: 0.95em;
                      opacity: 0.95;
                      font-weight: 500;
                      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                  }

                  .card {
                      /* „Ç´„Éº„Éâ„ÇÇ„Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†„ÅßÁµ±‰∏Ä„ÄúüéÄ */
                      background: rgba(255, 255, 255, 0.3);
                      backdrop-filter: blur(10px);
                      -webkit-backdrop-filter: blur(10px);
                      border-left: 4px solid rgba(255, 255, 255, 0.5);
                      padding: 25px;
                      margin: 20px 0;
                      border-radius: 16px;
                      border: 1px solid rgba(255, 255, 255, 0.25);
                      box-shadow:
                          0 8px 32px 0 rgba(31, 38, 135, 0.15),
                          inset 0 0 0 1px rgba(255, 255, 255, 0.1);
                      transition: all 0.3s ease;
                  }

                  .card:hover {
                      transform: translateY(-3px) translateX(5px);
                      box-shadow:
                          0 12px 40px 0 rgba(31, 38, 135, 0.25),
                          inset 0 0 0 1px rgba(255, 255, 255, 0.2);
                      background: rgba(255, 255, 255, 0.35);
                  }

                  .status-badge {
                      display: inline-block;
                      padding: 10px 20px;
                      border-radius: 25px;
                      background: ${STATUS_COLOR};
                      color: white;
                      font-weight: bold;
                      margin: 10px 0;
                      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                  }

                  a {
                      color: #ffffff;
                      text-decoration: none;
                      font-weight: 700;
                      font-size: 1.2em;
                      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                      transition: all 0.3s ease;
                  }

                  a:hover {
                      color: #f0f0f0;
                      text-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
                  }

                  .description {
                      color: rgba(255, 255, 255, 0.9);
                      margin-top: 15px;
                      line-height: 1.7;
                      font-size: 0.95em;
                      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                  }

                  .emoji {
                      font-size: 1.6em;
                      margin-right: 12px;
                      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
                  }

                  /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú„ÇÇ„Éê„ÉÉ„ÉÅ„É™üì±‚ú® */
                  @media (max-width: 768px) {
                      .stats {
                          flex-direction: column;
                      }

                      .container {
                          padding: 30px 25px;
                      }

                      h1 {
                          font-size: 2em;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üß™ Go CLI Sample Test Reports</h1>
                  <p class="subtitle">„ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏„É¨„Éù„Éº„Éà üìä‚ú®</p>

                  <div class="stats">
                      <div class="stat-box">
                          <div class="stat-label">Test Coverage</div>
                          <div class="stat-value">${COVERAGE}</div>
                          <div class="stat-label">„Ç≥„Éº„Éâ„Ç´„Éê„É¨„ÉÉ„Ç∏Áéá üéØ</div>
                      </div>
                      <div class="stat-box">
                          <div class="stat-label">Test Status</div>
                          <div class="stat-value">${STATUS_EMOJI}</div>
                          <div class="stat-label">${STATUS_TEXT}</div>
                      </div>
                  </div>

                  <div class="card">
                      <a href="coverage.html">
                          <span class="emoji">üìà</span>
                          „Ç´„Éê„É¨„ÉÉ„Ç∏„É¨„Éù„Éº„Éà„ÇíË¶ã„Çã
                      </a>
                      <p class="description">
                          „Ç≥„Éº„Éâ„ÅÆ„ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏„ÇíË¶ñË¶öÁöÑ„Å´Á¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ<br>
                          „Å©„ÅÆÈÉ®ÂàÜ„Åå„ÉÜ„Çπ„Éà„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅ‰∏ÄÁõÆ„Åß„Çè„Åã„Çã„Çà„ÄúÔºÅüéÄ
                      </p>
                  </div>

                  <div class="card">
                      <a href="test-output.txt">
                          <span class="emoji">üìù</span>
                          „ÉÜ„Çπ„ÉàÂá∫Âäõ„É≠„Ç∞„ÇíË¶ã„Çã
                      </a>
                      <p class="description">
                          „ÉÜ„Çπ„Éà„ÅÆË©≥Á¥∞„Å™Âá∫ÂäõÁµêÊûú„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åß„Åç„Åæ„Åô„ÄÇ<br>
                          „Ç®„É©„Éº„ÅåÂá∫„Å¶„Åü„Çâ„Åì„Åì„ÅßÁ¢∫Ë™ç„Åó„Å¶„Å≠ÔºÅüí™‚ú®
                      </p>
                  </div>

                  <div class="card">
                      <p style="color: #4a5568; margin: 0;">
                          <span class="emoji">üîó</span>
                          <strong>GitHub Repository:</strong><br>
                          <a href="https://github.com/Sunwood-ai-labs/go-cli-sample" target="_blank">
                              Sunwood-ai-labs/go-cli-sample
                          </a>
                      </p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'test-reports'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
