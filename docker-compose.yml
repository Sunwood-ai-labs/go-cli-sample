version: '3.8'

services:
  # Go CLI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: go-cli-sample-app
    volumes:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚¦ãƒ³ãƒˆï¼ˆé–‹ç™ºæ™‚ã®å¤‰æ›´ã‚’åæ˜ ï¼‰
      - .:/app
      # ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’æ°¸ç¶šåŒ–
      - ./test-reports:/app/test-reports
    environment:
      # Goç’°å¢ƒå¤‰æ•°
      - GOOS=linux
      - GOARCH=amd64
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
    command: ["go-cli-sample", "Dockerç’°å¢ƒã‹ã‚‰å®Ÿè¡Œã ã‚ˆã€œ"]
    
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨ã‚µãƒ¼ãƒ“ã‚¹
  test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: go-cli-sample-test
    volumes:
      - .:/app
      - ./test-reports:/app/test-reports
    # ãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
    command: >
      sh -c "
        echo 'ğŸ“ ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...' &&
        go test -v -cover -coverprofile=test-reports/coverage.out ./... | tee test-reports/test-results.txt &&
        echo 'ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...' &&
        go tool cover -html=test-reports/coverage.out -o test-reports/coverage.html &&
        echo 'âœ… ãƒ†ã‚¹ãƒˆå®Œäº†ï¼'
      "

  # ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œç”¨ã‚µãƒ¼ãƒ“ã‚¹
  benchmark:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: go-cli-sample-benchmark
    volumes:
      - .:/app
      - ./test-reports:/app/test-reports
    # ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    command: >
      sh -c "
        echo 'ğŸš€ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œä¸­...' &&
        go test -bench=. -benchmem ./... | tee test-reports/benchmark-results.txt &&
        echo 'âœ… ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Œäº†ï¼'
      "

  # é–‹ç™ºç”¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚·ã‚§ãƒ«ï¼‰
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: go-cli-sample-dev
    volumes:
      - .:/app
      - ./test-reports:/app/test-reports
    # ã‚·ã‚§ãƒ«ã‚’èµ·å‹•ï¼ˆé–‹ç™ºç”¨ï¼‰
    command: /bin/sh
    stdin_open: true
    tty: true
